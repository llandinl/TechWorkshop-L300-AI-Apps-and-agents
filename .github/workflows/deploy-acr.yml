name: Deploy to Azure Container Registry

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    name: Build and push Docker image to ACR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Create .env in build context (from secret)
        # Create an .env file inside the src/ folder so it is available during docker build.
        # This file is created at runtime from the secrets.ENV value and removed after the build/push.
        run: |
          mkdir -p src
          # Write secret to src/.env; do NOT print the value
          printf "%s" "${{ secrets.ENV }}" > src/.env

      - name: Build and push image to ACR
        uses: docker/build-push-action@v4
        with:
          context: ./src
          file: ./src/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/chat-app:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/chat-app:latest

      - name: Remove .env from workspace
        # Securely remove .env from the runner workspace after the image is pushed
        run: |
          if [ -f src/.env ]; then
            # Try shred (if available) then fallback to rm -f
            shred -u src/.env || rm -f src/.env
          fi
